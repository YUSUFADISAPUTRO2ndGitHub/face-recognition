<!DOCTYPE html>
<html>
<head>
  <script src="face-api.js"></script>
  <script src="js/imageSelectionControls.js"></script>
  <script src="js/faceDetectionControls.js"></script>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.css">
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="js/materialize.js"></script>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>
<style>
  /* CSS comes here */
  #video {
      border: 1px solid black;
      width: 800px;
      height: auto;
  }

  #photo {
      border: 1px solid black;
      width: 800px;
      height: auto;
  }

  #canvas {
      display: none;
  }

  .camera {
      width: 800px;
      display: inline-block;
  }

  .output {
      width: 800px;
      /* display: inline-block; */
      display: none;
  }

  #startbutton {
      display: block;
      position: relative;
      margin-left: auto;
      margin-right: auto;
      bottom: 36px;
      padding: 5px;
      background-color: #6a67ce;
      border: 1px solid rgba(255, 255, 255, 0.7);
      font-size: 14px;
      color: rgba(255, 255, 255, 1.0);
      cursor: pointer;
  }

  .contentarea {
      font-size: 16px;
      font-family: Arial;
      text-align: center;
  }
  .btn-primary{
    display: none;
  }
  </style>
<body>
  <div class="center-content page-container">

    <p> Your true face image: </p>
    <div style="position: relative" class="margin">
      <img id="refImg" src="" style="max-width: 800px;" />
      <canvas id="refImgOverlay" class="overlay"/>
    </div>

    <div class="row side-by-side">
      <div class="row">
        <label>Upload Image:</label>
        <div>
          <input id="refImgUploadInput" type="file" class="bold" onchange="uploadRefImage()" accept=".jpg, .jpeg, .png">
        </div>
      </div>
    </div>
    <p>Compare to face image: </p>
    <div style="position: relative" class="margin">
      <img id="queryImg" src="" style="max-width: 800px;" />
      <canvas id="queryImgOverlay" class="overlay"/>
    </div>
    <div class="row side-by-side">
      <div class="row">
        <label>Upload Image:</label>
        <div>
          <input id="queryImgUploadInput" type="file" class="bold" onchange="uploadQueryImage()" accept=".jpg, .jpeg, .png">
        </div>
      </div>
    </div>


    <div class="contentarea">
      <div class="camera">
          <video id="video">Video stream not available.</video>
      </div>
      <div><button id="startbutton">Take photo</button></div>
      <canvas id="canvas"></canvas>
      <div class="output">
          <img id="photo" alt="The screen capture will appear in this box.">
      </div>
    </div>
    <div>
      <button type="button" class="btn btn-primary" onclick="show_camera()">Take another Photo</button>
    </div>
  </body>

  <script>
    let faceMatcher = null

    async function uploadRefImage(e) {
      const imgFile = $('#refImgUploadInput').get(0).files[0]
      console.log((imgFile));
      const img = await faceapi.bufferToImage(imgFile)
      console.log((img));
      $('#refImg').get(0).src = img.src
      updateReferenceImageResults()
    }

    async function uploadQueryImage(e) {
      const imgFile = $('#queryImgUploadInput').get(0).files[0]
      const img = await faceapi.bufferToImage(imgFile)
      $('#queryImg').get(0).src = img.src
      updateQueryImageResults()
    }

    async function updateReferenceImageResults() {
      const inputImgEl = $('#refImg').get(0)
      const canvas = $('#refImgOverlay').get(0)

      const fullFaceDescriptions = await faceapi
        .detectAllFaces(inputImgEl, getFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptors()

      if (!fullFaceDescriptions.length) {
        return
      }

      // create FaceMatcher with automatically assigned labels
      // from the detection results for the reference image
      faceMatcher = new faceapi.FaceMatcher(fullFaceDescriptions)

      faceapi.matchDimensions(canvas, inputImgEl)
      // resize detection and landmarks in case displayed image is smaller than
      // original size
      const resizedResults = faceapi.resizeResults(fullFaceDescriptions, inputImgEl)
      // draw boxes with the corresponding label as text
      const labels = faceMatcher.labeledDescriptors
        .map(ld => ld.label)
      resizedResults.forEach(({ detection, descriptor }) => {
        const label = faceMatcher.findBestMatch(descriptor).toString()
        const options = { label }
        const drawBox = new faceapi.draw.DrawBox(detection.box, options)
        drawBox.draw(canvas)
      })
    }

    async function updateQueryImageResults() {
      if (!faceMatcher) {
        return
      }

      const inputImgEl = $('#queryImg').get(0)
      const canvas = $('#queryImgOverlay').get(0)

      const results = await faceapi
        .detectAllFaces(inputImgEl, getFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptors()

      faceapi.matchDimensions(canvas, inputImgEl)
      // resize detection and landmarks in case displayed image is smaller than
      // original size
      const resizedResults = faceapi.resizeResults(results, inputImgEl)

      resizedResults.forEach(({ detection, descriptor }) => {
        const label = faceMatcher.findBestMatch(descriptor).toString()
        const options = { label }
        // console.log(faceMatcher.findBestMatch(descriptor)._distance);
        console.log("start");
        const drawBox = new faceapi.draw.DrawBox(detection.box, options)
        console.log(resizedResults.length);
        if(faceMatcher.findBestMatch(descriptor)._distance >= 0.50){
          drawBox.draw(canvas, "#B71C1C")
          Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Face do not match'
          })
        }else if(resizedResults.length > 1){
          if(faceMatcher.findBestMatch(descriptor)._distance >= 0.50){
            drawBox.draw(canvas, "#B71C1C")
          }else{
            drawBox.draw(canvas, "#18FFFF")
          }
          Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'I found more than 1 face'
          })
        }else{
          drawBox.draw(canvas, "#18FFFF")
          Swal.fire({
            icon: 'success',
            title: 'Congrats',
            text: 'Face do match'
          })
        }
      })
    }

    async function updateResults() {
      await updateReferenceImageResults()
      await updateQueryImageResults()
    }

    async function run() {
      // load face detection, face landmark model and face recognition models
      await changeFaceDetector(selectedFaceDetector)
      await faceapi.loadFaceLandmarkModel('/')
      await faceapi.loadFaceRecognitionModel('/')
    }

    $(document).ready(function() {
      run()
    })

    var width = 800; // We will scale the photo width to this
        var height = 0; // This will be computed based on the input stream

        var streaming = false;

        var video = null;
        var canvas = null;
        var photo = null;
        var startbutton = null;

        function startup() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            photo = document.getElementById('photo');
            startbutton = document.getElementById('startbutton');

            navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: false
                })
                .then(function(stream) {
                    video.srcObject = stream;
                    video.play();
                })
                .catch(function(err) {
                    console.log("An error occurred: " + err);
                });

            video.addEventListener('canplay', function(ev) {
                if (!streaming) {
                    height = video.videoHeight / (video.videoWidth / width);

                    if (isNaN(height)) {
                        height = width / (4 / 3);
                    }

                    video.setAttribute('width', width);
                    video.setAttribute('height', height);
                    canvas.setAttribute('width', width);
                    canvas.setAttribute('height', height);
                    streaming = true;
                }
            }, false);

            startbutton.addEventListener('click', function(ev) {
                takepicture();
                ev.preventDefault();
            }, false);

            clearphoto();
        }


        function clearphoto() {
            var context = canvas.getContext('2d');
            context.fillStyle = "#AAA";
            context.fillRect(0, 0, canvas.width, canvas.height);

            var data = canvas.toDataURL('image/png');
            photo.setAttribute('src', data);
            // alert(data);
        }

        function takepicture() {
            var context = canvas.getContext('2d');
            if (width && height) {
                canvas.width = width;
                canvas.height = height;
                context.drawImage(video, 0, 0, width, height);

                var data = canvas.toDataURL('image/png');
                photo.setAttribute('src', data);
                console.log(data);
                canvas.toBlob(async function(blob){
                  console.log(URL.createObjectURL(blob));
                  const img = await faceapi.bufferToImage(blob);
                  $('#queryImg').get(0).src = img.src
                  updateQueryImageResults()
                },'image/png');
                $(".contentarea").css("display","none")
                $(".btn-primary").css("display","block")
            } else {
                clearphoto();
            }
        }

        function show_camera(){
          $(".contentarea").css("display","block")
          $(".btn-primary").css("display","none")
        }
        window.addEventListener('load', startup, false);
  </script>
</body>
</html>